{"version":3,"file":"react-global-states.umd.js","sources":["../node_modules/@babel/runtime/helpers/extends.js","../src/index.js"],"sourcesContent":["function _extends() {\n  module.exports = _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n\n    return target;\n  };\n\n  return _extends.apply(this, arguments);\n}\n\nmodule.exports = _extends;","import { useState, useEffect } from 'react';\n\n// \"The\" global store\nlet store = {};\n\n// internal publisher-subscriber system to\n// notify containers of store changes.\nconst pubsub = {\n  handlers: [],\n  subscribe(handler) {\n    // console.log('subscribed');\n    if (!this.handlers.includes(handler)) {\n      this.handlers.push(handler);\n    }\n  },\n  unsubscribe(handler) {\n    // console.log('unsubscribed');\n    const index = this.handlers.indexOf(handler);\n    if (index > -1) {\n      this.handlers.splice(index, 1);\n    }\n  },\n  notify(newStore) {\n    this.handlers.forEach(handler => handler(newStore));\n  }\n};\n\nexport const getStates = () => {\n  return { ...store };\n};\n\n// global state merger. unlike redux, I am not enforcing reducer layer\nexport const updateStates = (partial) => {\n  const newStore = {\n    ...store,\n    ...partial,\n  };\n  store = newStore;\n  pubsub.notify(newStore);\n};\n\n// curry function to partially update a sub property of global store.\n// e.g const updateCartState = createSubPropUpdater('cart');\n// updateCartState({ items: [], quantity: 0 });\n// this is equivalent to\n// updateStates({ cart: { ...store.cart, items: [], quantity: 0 } })\nexport const createSubPropUpdater = (propName) => {\n  return (partial) => {\n    const newStore = {\n      ...store,\n      [propName]: {\n        ...(store[propName] || {}),\n        ...partial,\n      }\n    };\n    store = newStore;\n    pubsub.notify(newStore);\n  };\n};\n\n// utility\nconst plainObjectPrototype = Object.getPrototypeOf({});\nconst twoLevelIsEqual = (oldState, newState, level = 1) => {\n  if (\n    oldState === null\n    || newState === null\n    || oldState === undefined\n    || newState === undefined\n  ) {\n    return oldState === newState;\n  }\n\n  const oldStatePrototype = Object.getPrototypeOf(oldState);\n  if (\n    level <= 2\n    && (oldStatePrototype === plainObjectPrototype || Array.isArray(oldState))\n    && oldStatePrototype === Object.getPrototypeOf(newState)\n  ) {\n    // check if all props of oldState is in newState\n    let isEqual = Object\n      .entries(oldState)\n      .every(([key, val]) => twoLevelIsEqual(val, newState[key], level + 1));\n    // check if all props of newState is in oldState\n    isEqual = isEqual && Object\n      .entries(newState)\n      .every(([key, val]) => twoLevelIsEqual(oldState[key], val, level + 1));\n    // if so, they are equal (upto two levels).\n    return isEqual;\n  }\n  if (oldState instanceof Date && newState instanceof Date) {\n    return oldState.getTime() === newState.getTime();\n  }\n  return oldState === newState;\n};\n\nexport const useGlobalStates = (propsToConnectTo = []) => {\n  let [state, setState] = useState(\n    propsToConnectTo.reduce((acc, propName) => {\n      if (propName in store) {\n        acc[propName] = store[propName];\n      }\n      return acc;\n    }, {}),\n  );\n\n  const propNameHash = propsToConnectTo.slice().sort().join('|');\n  useEffect(() => {\n    const newStateHandler = (newStore) => {\n      const newState = propsToConnectTo.reduce((acc, propName) => {\n        if (propName in newStore) {\n          acc[propName] = newStore[propName];\n        }\n        return acc;\n      }, {});\n      // console.log('current state', state);\n      // console.log('new state', newState);\n      // console.log('twoLevelIsEqual', twoLevelIsEqual(state, newState));\n      if (!twoLevelIsEqual(state, newState)) {\n        setState(newState);\n      }\n    };\n    pubsub.subscribe(newStateHandler);\n    // on component unmount, unsubscribe to prevent mem leak\n    return () => pubsub.unsubscribe(newStateHandler);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [state, propNameHash]);\n\n  return state;\n};"],"names":["store","pubsub","handlers","subscribe","handler","includes","push","unsubscribe","index","indexOf","splice","notify","newStore","forEach","getStates","updateStates","partial","createSubPropUpdater","propName","plainObjectPrototype","Object","getPrototypeOf","twoLevelIsEqual","oldState","newState","level","undefined","oldStatePrototype","Array","isArray","isEqual","entries","every","key","val","Date","getTime","useGlobalStates","propsToConnectTo","useState","reduce","acc","state","setState","propNameHash","slice","sort","join","useEffect","newStateHandler"],"mappings":"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"}